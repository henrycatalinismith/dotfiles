" Mirror NERDTree automatically
" https://github.com/preservim/nerdtree?tab=readme-ov-file#can-i-have-the-same-nerdtree-on-every-tab-automatically
autocmd BufWinEnter * if &buftype != "quickfix" && getcmdwintype() == "" | silent NERDTreeMirror | endif

" Create a custom highlight group for the NERDTree background so it's possible
" to set a custom background color
autocmd FileType nerdtree setlocal wincolor=NERDTreeNormal

" Turn off the annoying beep
autocmd! GUIEnter * set vb t_vb=

" High contrast solarized with way brighter colours
colorscheme solarized8_high

" Turn on Vim's built-in file type detection magic
filetype plugin indent on

" Hide the ~ characters in an empty buffer
highlight! EndOfBuffer guifg=bg

" De-emphasise GitGutter markers
highlight! GitGutterAdd guibg=NONE
highlight! GitGutterChange guibg=NONE
highlight! GitGutterDelete guibg=NONE

" Make LinNr bg same as editor area bg
highlight! LineNr guibg=#052c39
highlight! Normal guibg=#052c39 guifg=#fdf5dc

" Make NERDTree bg a little different to stand out
highlight! NERDTreeNormal guibg=#0c313c

" This is the main text editor area bg/fg
highlight! Normal guibg=#052c39 guifg=#fdf5dc

highlight TabLineFill guifg=#25424e

" Slightly brighter splits
highlight! VertSplit guibg=#223d46

" SignColumn & LineNr => same colour
highlight! link SignColumn LineNr

" Learned these Alt+Up & Alt+Down shortcuts to move lines around from VS Code
" and can't live without them any more!
inoremap <M-Down> <Esc>:m +1<CR>
inoremap <M-Up> <Esc>:m -2<CR>

" Hide 'Press ? for help' and so on
let g:NERDTreeMinimalUI=1

" One click to open directories, two for files
let g:NERDTreeMouseMode=2

" https://github.com/vim-airline/vim-airline/blob/master/doc/airline.txt
let g:airline#extensions#branch#enabled = 1
let g:airline#extensions#tabline#enabled = 1
let g:airline_powerline_fonts = 0
let g:airline_theme="solarized_flood"

" Space is the best leader key
map <Space> <Leader>

" Ex mode: no thanks
map Q <nop>

" Make Y work like C and D
map Y y$

" Ctrl + Shift + Tab to go back a tab
nnoremap <C-S-Tab> :tabprevious<CR>

" <Space> b to open NERDTree
nnoremap <leader>b :NERDTree<CR>

" <Space> g to grep
nnoremap <leader>g :RG<CR>

" Alt+Up and Alt+Down to move lines around
nnoremap <M-Down> :m .+1<CR>
nnoremap <M-Up> :m .-2<CR>

" <Space> p for filename fzf
nnoremap <leader>p :GFiles<CR>

" <Space> q for quick exit
nnoremap <leader>q :quit!<CR>

" <Space> t to open a new terminal
nnoremap <leader>t :call OpenTerminal()<CR>

" <Space> w for quicksave
nnoremap <leader>w :write<CR>

" Solarized dark is dark!
set bg=dark

" Make vsplit markers flat
set fillchars=""

" https://typeof.net/Iosevka/
set guifont=Iosevka:h18

" Case insensitive search
set ignorecase

" Incremental search
set incsearch

" No beeping
set noerrorbells

" Swap files are annoying
set noswapfile

" Flashing is annoying
set novisualbell

" Line numbers
set number

" 2 means always, even when only one tab is open
set showtabline=2

" Yes means always, even when empty, avoiding a layout shift if enabling later
set signcolumn=yes

" Smartindent is pretty good
set smartindent

" Default is 4000 which is too slow for git-related stuff
set updatetime=16

" Set up next/prev tab shortcuts in terminal mode
tnoremap <C-S-Tab> <C-\><C-N>:tabprevious<CR>
tnoremap <C-Tab> <C-\><C-N>:tabnext<CR>

" Hit escape twice to enter normal mode in the terminal.
" It's twice instead of the usual once because some terminal programs listen
" for escape keypresses and we don't want to mess with that.
tnoremap <Esc><Esc> <C-\><C-N>

if executable("typescript-language-server")
  au User lsp_setup call lsp#register_server({
  \ "name": "typescript support using typescript-language-server",
  \ "cmd": {server_info->[&shell, &shellcmdflag, "typescript-language-server --stdio"]},
  \ "root_uri":{server_info->lsp#utils#path_to_uri(lsp#utils#find_nearest_parent_file_directory(lsp#utils#get_buffer_path(), "tsconfig.json"))},
  \ "whitelist": ["typescript", "typescript.tsx", "typescriptreact"],
  \ })
end

function! s:on_lsp_buffer_enabled() abort
  setlocal omnifunc=lsp#complete
  setlocal signcolumn=yes
  if exists("+tagfunc") | setlocal tagfunc=lsp#tagfunc | endif
  nmap <buffer> gd <plug>(lsp-definition)
  nmap <buffer> gr <plug>(lsp-references)
  nmap <buffer> gi <plug>(lsp-implementation)
  nmap <buffer> gt <plug>(lsp-type-definition)
  nmap <buffer> <leader>rn <plug>(lsp-rename)
  nmap <buffer> [g <plug>(lsp-previous-diagnostic)
  nmap <buffer> ]g <plug>(lsp-next-diagnostic)
  nmap <buffer> gh <plug>(lsp-hover)
  nmap <buffer> <leader>. :LspCodeAction --ui=float<CR>

  let g:lsp_format_sync_timeout = 1000
  autocmd! BufWritePre *.rs,*.go call execute("LspDocumentFormatSync")
endfunction

augroup lsp_install
  au!
  " call s:on_lsp_buffer_enabled only for languages that has the server registered.
  autocmd User lsp_buffer_enabled call s:on_lsp_buffer_enabled()
augroup END

function! TerminalInsertMode()
  echom "TerminalInsertMode called"
  echom "Current buftype: " . &buftype
  if &buftype ==# "terminal"
    call timer_start(10, { -> execute("startinsert") })
  endif
endfunction

function! OpenTerminal()
  let commands = ["terminal ++curwin"]
  let is_empty_buffer = bufname("%") ==# "" && line("$") == 1 && getline(1) == ""
  " When opening from an empty buffer we skip the tabnew step and just convert
  " the current buffer directly to a terminal.
  if !is_empty_buffer
    call insert(commands, "tabnew", 0)
  endif
  execute join(commands, " | ")
endfunction
